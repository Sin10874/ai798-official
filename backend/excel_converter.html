<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel æ•°æ®è½¬æ¢å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: monospace;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background: #0B0B0E;
            color: #E7E8EA;
        }
        h1 { color: #3AA56A; }
        .section {
            background: #111215;
            border: 4px solid #000;
            padding: 20px;
            margin: 20px 0;
        }
        input[type="file"] {
            margin: 10px 0;
            padding: 10px;
            background: #000;
            color: #3AA56A;
            border: 2px solid #333;
        }
        button {
            background: #F4C230;
            color: #111;
            border: 4px solid #000;
            padding: 10px 20px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 5px;
        }
        textarea {
            width: 100%;
            height: 300px;
            background: #000;
            color: #3AA56A;
            border: 2px solid #333;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        .success { color: #3AA56A; }
        .error { color: #ef4444; }
    </style>
</head>
<body>
    <h1>ğŸ“Š Excel æ•°æ®è½¬æ¢å·¥å…·</h1>
    <p>å°†ä½ çš„ Excel æ–‡ä»¶è½¬æ¢ä¸º Supabase SQL è¯­å¥</p>

    <div class="section">
        <h2>1. ä¸Šä¼ åå• Excel</h2>
        <input type="file" id="usersFile" accept=".xlsx,.xls">
        <p style="color: #A5A8AD; font-size: 14px;">
            * å‡è®¾ç¬¬1åˆ—=å§“åï¼Œç¬¬2åˆ—=æ‰‹æœºå·<br>
            * å£ä»¤å°†ç»Ÿä¸€è®¾ç½®ä¸º "111111"ï¼ˆç¨åå¯åœ¨ SQL ä¸­ä¿®æ”¹ï¼‰
        </p>
        <div id="usersStatus"></div>
    </div>

    <div class="section">
        <h2>2. ä¸Šä¼ æ‰“å¡ä»»åŠ¡ Excel</h2>
        <input type="file" id="tasksFile" accept=".xlsx,.xls">
        <p style="color: #A5A8AD; font-size: 14px;">
            * å‡è®¾ç¬¬1åˆ—=æ—¥æœŸï¼Œç¬¬2åˆ—=é¢˜ç›®å†…å®¹
        </p>
        <div id="tasksStatus"></div>
    </div>

    <div class="section">
        <h2>3. ç”Ÿæˆ SQL</h2>
        <button onclick="generateSQL()">ç”Ÿæˆ SQL è¯­å¥</button>
        <button onclick="copySQL()">å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
        <button onclick="downloadSQL()">ä¸‹è½½ seed.sql</button>
        <textarea id="sqlOutput" placeholder="SQL è¯­å¥å°†åœ¨è¿™é‡Œæ˜¾ç¤º..."></textarea>
    </div>

    <script>
        let usersData = [];
        let tasksData = [];

        // å¤„ç†åå•æ–‡ä»¶
        document.getElementById('usersFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    usersData = jsonData.slice(1).filter(row => row[0] && row[1]); // è·³è¿‡è¡¨å¤´ï¼Œè¿‡æ»¤ç©ºè¡Œ
                    document.getElementById('usersStatus').innerHTML = 
                        `<p class="success">âœ“ æˆåŠŸè¯»å– ${usersData.length} æ¡ç”¨æˆ·æ•°æ®</p>`;
                } catch (err) {
                    document.getElementById('usersStatus').innerHTML = 
                        `<p class="error">âœ— è¯»å–å¤±è´¥: ${err.message}</p>`;
                }
            };
            
            reader.readAsArrayBuffer(file);
        });

        // å¤„ç†ä»»åŠ¡æ–‡ä»¶
        document.getElementById('tasksFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    tasksData = jsonData.slice(1).filter(row => row[0] && row[1]); // è·³è¿‡è¡¨å¤´
                    document.getElementById('tasksStatus').innerHTML = 
                        `<p class="success">âœ“ æˆåŠŸè¯»å– ${tasksData.length} æ¡ä»»åŠ¡æ•°æ®</p>`;
                } catch (err) {
                    document.getElementById('tasksStatus').innerHTML = 
                        `<p class="error">âœ— è¯»å–å¤±è´¥: ${err.message}</p>`;
                }
            };
            
            reader.readAsArrayBuffer(file);
        });

        function generateSQL() {
            let sql = [];
            
            // ç”Ÿæˆç”¨æˆ· SQL
            sql.push('-- ç”¨æˆ·æ•°æ®');
            usersData.forEach(row => {
                const name = String(row[0]).trim().replace(/'/g, "''");
                const phone = String(row[1]).trim();
                const token = "111111"; // é»˜è®¤å£ä»¤
                
                sql.push(`INSERT INTO public.users (name, phone, token) VALUES ('${name}', '${phone}', '${token}') ON CONFLICT (phone) DO NOTHING;`);
            });
            
            sql.push('\n-- ä»»åŠ¡æ•°æ®');
            tasksData.forEach(row => {
                let dateVal = row[0];
                const content = String(row[1]).trim().replace(/'/g, "''");
                
                // å¤„ç†æ—¥æœŸæ ¼å¼
                if (typeof dateVal === 'number') {
                    // Excel æ—¥æœŸæ˜¯ä» 1900-01-01 å¼€å§‹çš„å¤©æ•°
                    const date = XLSX.SSF.parse_date_code(dateVal);
                    dateVal = `${date.y}-${String(date.m).padStart(2, '0')}-${String(date.d).padStart(2, '0')}`;
                } else if (dateVal instanceof Date) {
                    dateVal = dateVal.toISOString().split('T')[0];
                } else {
                    dateVal = String(dateVal).split(' ')[0];
                }
                
                sql.push(`INSERT INTO public.questions (date, content) VALUES ('${dateVal}', '${content}') ON CONFLICT (date) DO UPDATE SET content = EXCLUDED.content;`);
            });
            
            document.getElementById('sqlOutput').value = sql.join('\n');
        }

        function copySQL() {
            const textarea = document.getElementById('sqlOutput');
            textarea.select();
            document.execCommand('copy');
            alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        }

        function downloadSQL() {
            const sql = document.getElementById('sqlOutput').value;
            const blob = new Blob([sql], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'seed.sql';
            a.click();
        }
    </script>
</body>
</html>
