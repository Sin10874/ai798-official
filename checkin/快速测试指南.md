# 评论功能快速测试指南

## 🚀 快速开始

### 步骤1：创建数据库表（必须先做）

1. 打开 Supabase Dashboard: https://supabase.com/dashboard
2. 选择您的项目
3. 点击左侧 "SQL Editor"
4. 复制 `comments_table.sql` 的全部内容
5. 粘贴到 SQL Editor 中
6. 点击 "Run" 执行

执行成功后会看到绿色提示 "Success"

### 步骤2：验证表创建

1. 点击左侧 "Table Editor"
2. 在表列表中找到 "comments" 表
3. 点击查看表结构，确认字段都存在

### 步骤3：测试评论功能

1. 打开打卡系统并登录
2. 访问 `history.html` 打卡回顾墙
3. 找到任意一条打卡记录

## 📝 功能测试清单

### 测试1: 基础评论功能
- [ ] 在评论输入框中输入文字
- [ ] 点击"发送"按钮
- [ ] 确认评论立即显示在列表中
- [ ] 确认评论数量增加
- [ ] 确认显示"刚刚"时间标签

### 测试2: 回复功能
- [ ] 点击某条评论下的"回复"按钮
- [ ] 确认弹出回复输入框
- [ ] 输入回复内容
- [ ] 点击"发送"
- [ ] 确认回复显示在该评论下方（缩进显示）
- [ ] 点击"取消"按钮能关闭回复框

### 测试3: 折叠功能（需要准备数据）

**准备工作：** 给同一条评论添加4条以上的回复

手动添加测试数据方法：
1. 在 Supabase SQL Editor 中执行：

```sql
-- 获取一个打卡记录的ID
SELECT id, user_name FROM checkins LIMIT 1;

-- 替换下面的 YOUR_CHECKIN_ID, USER_ID, USER_NAME 后执行
INSERT INTO comments (checkin_id, user_id, user_name, content, parent_id) 
VALUES 
  ('YOUR_CHECKIN_ID', 'USER_ID', 'USER_NAME', '这是第一条评论', NULL);

-- 获取刚创建的评论ID
SELECT id FROM comments WHERE content = '这是第一条评论' ORDER BY created_at DESC LIMIT 1;

-- 用上面的评论ID替换 PARENT_COMMENT_ID，添加多条回复
INSERT INTO comments (checkin_id, user_id, user_name, content, parent_id) 
VALUES 
  ('YOUR_CHECKIN_ID', 'USER_ID', 'USER_NAME', '回复1', 'PARENT_COMMENT_ID'),
  ('YOUR_CHECKIN_ID', 'USER_ID', 'USER_NAME', '回复2', 'PARENT_COMMENT_ID'),
  ('YOUR_CHECKIN_ID', 'USER_ID', 'USER_NAME', '回复3', 'PARENT_COMMENT_ID'),
  ('YOUR_CHECKIN_ID', 'USER_ID', 'USER_NAME', '回复4', 'PARENT_COMMENT_ID'),
  ('YOUR_CHECKIN_ID', 'USER_ID', 'USER_NAME', '回复5', 'PARENT_COMMENT_ID');
```

**测试步骤：**
- [ ] 刷新页面
- [ ] 找到有4条以上回复的评论
- [ ] 确认只显示最新的2条回复
- [ ] 确认显示"展开全部 X 条回复"按钮
- [ ] 点击"展开全部"按钮
- [ ] 确认所有回复都显示出来
- [ ] 确认按钮文字变为"收起"
- [ ] 点击"收起"按钮
- [ ] 确认恢复为只显示最新2条

### 测试4: 边界情况
- [ ] 尝试提交空评论（应该提示"评论内容不能为空"）
- [ ] 输入很长的文字（测试换行显示）
- [ ] 输入特殊字符 `<script>alert('test')</script>` （应该正常显示，不执行）
- [ ] 快速连续点击发送（测试重复提交）

### 测试5: 用户体验
- [ ] 输入框自动调整高度（多行文字）
- [ ] 评论时间显示正确（刚刚、X分钟前等）
- [ ] 页面加载时评论自动加载
- [ ] 评论提交后输入框自动清空
- [ ] 鼠标悬停效果正常

## 🐛 常见问题排查

### 问题1: 评论无法显示
**排查步骤：**
1. 打开浏览器控制台（F12）
2. 查看 Console 是否有错误
3. 检查 Network 标签，查看 API 请求是否成功
4. 确认 comments 表是否创建成功

### 问题2: 无法提交评论
**可能原因：**
- 未登录（检查 localStorage 中的 ai798_auth）
- 评论内容为空
- RLS 策略配置错误

**解决方法：**
```sql
-- 在 Supabase SQL Editor 中检查策略
SELECT * FROM pg_policies WHERE tablename = 'comments';
```

### 问题3: 评论提交后不刷新
**排查：**
- 检查 `loadComments()` 函数是否被调用
- 查看控制台是否有 JavaScript 错误

## 📊 数据库查询测试

在 Supabase SQL Editor 中执行以下查询来验证数据：

```sql
-- 查看所有评论
SELECT * FROM comments ORDER BY created_at DESC;

-- 查看某条打卡的评论统计
SELECT 
  checkin_id,
  COUNT(*) FILTER (WHERE parent_id IS NULL) as 一级评论数,
  COUNT(*) FILTER (WHERE parent_id IS NOT NULL) as 回复数,
  COUNT(*) as 总评论数
FROM comments 
GROUP BY checkin_id;

-- 查看评论树结构
SELECT 
  c1.id as 评论ID,
  c1.user_name as 评论者,
  c1.content as 内容,
  COUNT(c2.id) as 回复数
FROM comments c1
LEFT JOIN comments c2 ON c2.parent_id = c1.id
WHERE c1.parent_id IS NULL
GROUP BY c1.id, c1.user_name, c1.content
ORDER BY c1.created_at DESC;
```

## ✅ 测试完成清单

完成所有测试后，确认以下功能正常：

- [x] 数据库表创建成功
- [ ] 一级评论可以正常提交和显示
- [ ] 二级回复可以正常提交和显示
- [ ] 超过3条回复自动折叠
- [ ] 展开/收起功能正常
- [ ] 评论数量实时更新
- [ ] 时间显示格式正确
- [ ] HTML特殊字符正确转义
- [ ] 输入框体验良好
- [ ] 无JavaScript错误

## 🎉 测试通过

如果所有测试都通过，恭喜！评论功能已成功集成。

可以开始正常使用了。

---

遇到问题？检查：
1. `评论功能使用说明.md` 完整文档
2. 浏览器控制台错误信息
3. Supabase Dashboard 的日志

