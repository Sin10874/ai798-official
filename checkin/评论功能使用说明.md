# 打卡评论功能使用说明

## 功能概述

已为打卡回顾墙页面（history.html）添加完整的评论功能，支持：

1. ✅ **一级评论**：用户可以直接评论打卡内容
2. ✅ **二级回复**：用户可以回复一级评论，回复自动收纳在对应评论下
3. ✅ **智能折叠**：当二级评论超过3条时，自动折叠，仅显示最新2条
4. ✅ **展开查看**：点击"展开全部"按钮可查看所有回复

## 部署步骤

### 1. 创建数据库表

在 Supabase Dashboard 的 SQL Editor 中执行 `comments_table.sql` 文件：

1. 登录 Supabase Dashboard
2. 进入项目
3. 点击左侧菜单 "SQL Editor"
4. 新建查询，粘贴 `comments_table.sql` 的内容
5. 点击 "Run" 执行

### 2. 验证表结构

执行成功后，在 "Table Editor" 中应该能看到 `comments` 表，包含以下字段：
- `id` (UUID) - 主键
- `checkin_id` (UUID) - 关联的打卡记录ID
- `user_id` (UUID) - 评论者ID
- `user_name` (TEXT) - 评论者姓名
- `content` (TEXT) - 评论内容
- `parent_id` (UUID) - 父评论ID（NULL表示一级评论）
- `created_at` (TIMESTAMP) - 创建时间
- `updated_at` (TIMESTAMP) - 更新时间

### 3. 检查 RLS 策略

确认以下策略已创建：
- ✅ 所有人可查看评论
- ✅ 已登录用户可创建评论
- ✅ 用户只能删除自己的评论
- ✅ 用户可以更新自己的评论

## 功能详解

### 一级评论
- 在每条打卡内容下方有评论输入框
- 输入评论内容后点击"发送"即可提交
- 评论会实时显示在评论列表中

### 二级回复
- 点击评论下方的"回复"按钮
- 展开回复输入框
- 输入回复内容后点击"发送"
- 回复会自动关联到对应的一级评论下

### 折叠与展开
- 当某条评论的回复数量 > 3 时：
  - 默认只显示最新的 2 条回复
  - 其余回复自动折叠
  - 显示"展开全部 X 条回复"按钮
- 点击"展开全部"：
  - 显示所有回复
  - 按钮文字变为"收起"
- 点击"收起"：
  - 恢复为只显示最新 2 条

## 技术实现

### 文件修改清单

1. **supabase.js** - 添加评论相关数据库操作
   - `getComments(checkinId)` - 获取评论列表
   - `addComment(...)` - 添加评论
   - `deleteComment(...)` - 删除评论

2. **app.js** - 添加评论渲染和交互逻辑
   - `loadComments(checkinId)` - 加载评论
   - `renderComment(...)` - 渲染单条评论
   - `submitComment(...)` - 提交评论
   - `submitReply(...)` - 提交回复
   - `toggleReplies(...)` - 展开/折叠回复

3. **style.css** - 添加评论模块样式
   - 评论区域样式
   - 输入框样式
   - 一级评论样式
   - 二级回复样式
   - 折叠按钮样式

### 数据流程

```
用户输入评论
    ↓
submitComment() / submitReply()
    ↓
addComment() - 调用 Supabase API
    ↓
loadComments() - 重新加载评论列表
    ↓
renderComment() - 渲染评论HTML
    ↓
更新页面显示
```

### 安全特性

- ✅ HTML转义，防止XSS攻击
- ✅ RLS策略保护数据安全
- ✅ 用户只能操作自己的评论
- ✅ 需登录才能评论

## UI/UX 特性

1. **现代化设计**
   - 半透明毛玻璃效果
   - 柔和的过渡动画
   - 响应式布局

2. **交互优化**
   - 自动调整输入框高度
   - 实时评论数量统计
   - 人性化的时间显示（刚刚、X分钟前等）

3. **视觉层次**
   - 一级评论突出显示
   - 二级回复缩进展示
   - 清晰的视觉分隔

## 测试建议

1. **基础功能测试**
   - [ ] 提交一级评论
   - [ ] 回复评论
   - [ ] 查看评论列表

2. **折叠功能测试**
   - [ ] 创建超过3条回复的评论
   - [ ] 验证只显示最新2条
   - [ ] 测试展开/收起功能

3. **边界情况测试**
   - [ ] 空内容提交
   - [ ] 未登录状态
   - [ ] 超长文本
   - [ ] 特殊字符

## 常见问题

### Q: 评论不显示？
A: 检查以下几点：
1. comments 表是否创建成功
2. RLS 策略是否正确配置
3. 浏览器控制台是否有错误

### Q: 无法提交评论？
A: 确认：
1. 用户是否已登录
2. 评论内容是否为空
3. 网络连接是否正常

### Q: 回复显示异常？
A: 检查：
1. parent_id 是否正确关联
2. 数据库中的 ON DELETE CASCADE 是否生效

## 后续优化建议

1. **功能增强**
   - 点赞功能
   - 评论排序（热门、最新）
   - @提及功能
   - 评论编辑功能

2. **性能优化**
   - 评论分页加载
   - 虚拟滚动
   - 评论缓存

3. **用户体验**
   - 评论通知
   - 表情符号支持
   - 图片上传

---

开发完成时间：2025-11-27
版本：v1.0.0

