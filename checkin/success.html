<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“å¡æˆåŠŸ - è®­ç»ƒè¥</title>
    <link rel="stylesheet" href="style.css">
    <!-- Confetti JS -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        .success-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            text-align: center;
            padding: 20px;
        }
        .success-icon {
            font-size: 64px;
            margin-bottom: 20px;
            animation: bounce 1s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .success-title {
            font-family: inherit;
            font-weight: 700;
            color: var(--yellow);
            margin-bottom: 20px;
            font-size: 24px;
            line-height: 1.5;
        }
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 300px;
            margin-top: 40px;
        }
    </style>
</head>
<body>
    <div class="container success-container">
        <div class="success-icon">ğŸ‰</div>
        <h1 class="success-title">æ‰“å¡æˆåŠŸ!</h1>
        <p class="pixel-h" style="color: var(--txt); font-size: 16px;">ä»Šæ—¥ä»»åŠ¡å·²å®Œæˆï¼Œç»§ç»­ä¿æŒï¼</p>
        <div style="margin-top: 20px; margin-bottom: 10px;">
            <span class="pixel-h" style="color: var(--muted); font-size: 14px;">å·²ç´¯è®¡æ‰“å¡ </span>
            <span id="checkinDays" class="pixel-h" style="color: var(--yellow); font-size: 24px; font-weight: bold;">0</span>
            <span class="pixel-h" style="color: var(--muted); font-size: 14px;"> å¤©</span>
        </div>
        
        <div class="action-buttons">
            <a href="/checkin/history" class="pixel-btn" style="background: var(--yellow); color: var(--bg); justify-content: center;">
                æŸ¥çœ‹æ‰“å¡å›é¡¾å¢™ <span style="margin-left: 8px;">â†’</span>
            </a>
            <a href="/" class="pixel-btn" style="background: var(--panel); color: var(--txt); justify-content: center;">
                è¿”å›é¦–é¡µ
            </a>
        </div>
    </div>

    <script src="supabase.js"></script>
    <script src="app.js"></script> <!-- å¤ç”¨ app.js ä¸­çš„ä¸€äº›å·¥å…·å‡½æ•° -->
    <script src="particles-bg.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // è·å–å¹¶æ˜¾ç¤ºç´¯è®¡æ‰“å¡å¤©æ•°
            try {
                const checkinDaysEl = document.getElementById('checkinDays');
                if (!checkinDaysEl) return;
                
                // ä¼˜å…ˆä» URL å‚æ•°è·å–å¤©æ•°
                const urlParams = new URLSearchParams(window.location.search);
                const daysFromUrl = urlParams.get('days');
                
                if (daysFromUrl) {
                    // å¦‚æœ URL ä¸­æœ‰å¤©æ•°å‚æ•°ï¼Œç›´æ¥ä½¿ç”¨
                    checkinDaysEl.textContent = daysFromUrl;
                } else {
                    // å¦åˆ™æŸ¥è¯¢æ•°æ®åº“
                    const user = getCurrentUser();
                    if (user && user.userId) {
                        const checkinCount = await getUserCheckinCount(user.userId);
                        checkinDaysEl.textContent = checkinCount;
                    }
                }
            } catch (error) {
                console.error('è·å–æ‰“å¡å¤©æ•°å¤±è´¥:', error);
            }
            

            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ’’èŠ±
            // é€»è¾‘ï¼š
            // 1. å¦‚æœ URL å¸¦æœ‰ ?new=trueï¼Œè¯´æ˜æ˜¯åˆšæäº¤å®Œï¼Œå¿…é¡»æ’’èŠ±
            // 2. å¦‚æœæ˜¯ä»Šæ—¥é¦–æ¬¡è®¿é—®æ­¤é¡µé¢ï¼ˆå³ä½¿ä¸æ˜¯åˆšæäº¤ï¼‰ï¼Œä¹Ÿæ’’èŠ±ï¼Ÿ
            //    ç”¨æˆ·éœ€æ±‚ï¼š"å½“æ—¥é¦–æ¬¡è¿›å…¥æ‰“å¡æˆåŠŸé¡µé¢ï¼Œéƒ½ä¼šå±•ç¤ºä¸€ä¸ªæ’’èŠ±ç‰¹æ•ˆ"
            
            const urlParams = new URLSearchParams(window.location.search);
            const isNewCheckin = urlParams.get('new') === 'true';
            
            // ä½¿ç”¨ app.js é‡Œçš„ getBJDateString ç¡®ä¿å’Œæ‰“å¡é€»è¾‘æ—¶é—´ä¸€è‡´
            const todayStr = typeof getBJDateString === 'function' ? getBJDateString() : new Date().toISOString().split('T')[0];
            const storageKey = 'ai798_confetti_shown_' + todayStr;
            const hasShown = localStorage.getItem(storageKey);

            if (isNewCheckin || !hasShown) {
                launchConfetti();
                localStorage.setItem(storageKey, 'true');
            }

            function launchConfetti() {
                var duration = 3000;
                var animationEnd = Date.now() + duration;
                var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

                var random = function(min, max) {
                  return Math.random() * (max - min) + min;
                };

                var interval = setInterval(function() {
                  var timeLeft = animationEnd - Date.now();

                  if (timeLeft <= 0) {
                    return clearInterval(interval);
                  }

                  var particleCount = 50 * (timeLeft / duration);
                  // since particles fall down, start a bit higher than random
                  confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.1, 0.3), y: Math.random() - 0.2 } }));
                  confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.7, 0.9), y: Math.random() - 0.2 } }));
                }, 250);
            }
        });
    </script>
</body>
</html>
