<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•æ•°æ®é‡ç½®å·¥å…·</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <style>
        .container {
            max-width: 500px;
            margin-top: 50px;
            text-align: center;
        }
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
            border: 1px solid var(--danger-color);
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .status-log {
            margin-top: 20px;
            text-align: left;
            background: #000;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            min-height: 100px;
            color: #333;
        }
        .log-line { color: var(--muted); margin-bottom: 4px; }
        .log-success { color: var(--success-color); }
        .log-error { color: var(--danger-color); }
    </style>
</head>
<body>
    <div class="container">
        <div class="pixel-card">
            <h1 style="margin-bottom: 20px; color: var(--txt);">ğŸš§ æµ‹è¯•é‡ç½®å·¥å…·</h1>
            
            <div style="margin-bottom: 20px;">
                <p style="color: var(--muted); font-size: 14px; margin-bottom: 10px;">å‰ç«¯çŠ¶æ€æ¸…ç†</p>
                <button id="clearLocalBtn" class="pixel-btn full-width">
                    1. æ¸…é™¤æœ¬åœ°ç™»é™†ç¼“å­˜
                </button>
            </div>

            <div style="margin-bottom: 20px;">
                <p style="color: var(--muted); font-size: 14px; margin-bottom: 10px;">åç«¯æ•°æ®æ¸…ç† (æ…ç”¨)</p>
                <button id="clearCheckinsBtn" class="pixel-btn btn-danger full-width">
                    2. æ¸…ç©ºæ‰€æœ‰æ‰“å¡è®°å½• (checkinsè¡¨)
                </button>
            </div>

            <div style="border-top: 1px solid var(--stroke); padding-top: 20px; margin-top: 20px;">
                 <a href="/checkin/login" class="pixel-btn" style="background: var(--panel); color: var(--txt); width: 100%; justify-content: center;">
                    è¿”å›ç™»é™†é¡µ
                </a>
            </div>
        </div>

        <div id="logBox" class="status-log">
            <div class="log-line">å‡†å¤‡å°±ç»ª...</div>
        </div>
    </div>

    <script src="supabase.js"></script>
    <script>
        // æ—¥å¿—å·¥å…·
        function log(msg, type = 'normal') {
            const box = document.getElementById('logBox');
            const div = document.createElement('div');
            div.className = 'log-line';
            if (type === 'success') div.classList.add('log-success');
            if (type === 'error') div.classList.add('log-error');
            div.textContent = `> ${msg}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // 1. æ¸…é™¤æœ¬åœ°ç¼“å­˜
        document.getElementById('clearLocalBtn').addEventListener('click', () => {
            try {
                const key = 'ai798_auth'; // å¯¹åº” app.js é‡Œçš„ AUTH_KEY
                // ä¹Ÿå¯ä»¥ç›´æ¥æ¸…é™¤æ‰€æœ‰
                localStorage.clear();
                log('æœ¬åœ° localStorage å·²æ¸…ç©º', 'success');
                log('ç™»é™†çŠ¶æ€å·²é‡ç½®');
            } catch (e) {
                log('æ¸…é™¤æœ¬åœ°ç¼“å­˜å¤±è´¥: ' + e.message, 'error');
            }
        });

        // 2. æ¸…ç©ºæ•°æ®åº“æ‰“å¡è®°å½•
        document.getElementById('clearCheckinsBtn').addEventListener('click', async () => {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ•°æ®åº“ä¸­æ‰€æœ‰çš„æ‰“å¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

            try {
                log('æ­£åœ¨è¿æ¥ Supabase åˆ é™¤æ•°æ®...');
                
                // æ³¨æ„ï¼šSupabase JS å®¢æˆ·ç«¯åˆ é™¤æ‰€æœ‰è¡Œéœ€è¦ç‰¹å®šçš„è¿‡æ»¤æ¡ä»¶
                // è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ checkins è¡¨çš„ä¸»é”® id ä¸ä¸ºç©ºä½œä¸ºæ¡ä»¶
                const { data, error } = await supabase
                    .from('checkins')
                    .delete()
                    .neq('id', '00000000-0000-0000-0000-000000000000'); // åˆ é™¤æ‰€æœ‰ ID ä¸ä¸º 0 çš„è®°å½•ï¼ˆå®é™…ä¸Šæ˜¯æ‰€æœ‰ï¼‰

                if (error) {
                    throw error;
                }

                log('checkins è¡¨æ•°æ®å·²æ¸…ç©º', 'success');
            } catch (e) {
                console.error(e);
                log('åˆ é™¤æ•°æ®åº“æ•°æ®å¤±è´¥: ' + e.message, 'error');
                log('æç¤ºï¼šè¯·æ£€æŸ¥ Supabase RLS ç­–ç•¥æ˜¯å¦å…è®¸åˆ é™¤æ“ä½œ', 'error');
            }
        });

        // è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡æœ¬åœ°æ¸…ç†ï¼ˆå¯é€‰ï¼Œæ–¹ä¾¿ç”¨æˆ·ä¸€è¿›æ¥å°±é‡ç½®ï¼‰
        // localStorage.clear();
        // log('å·²è‡ªåŠ¨æ¸…é™¤æœ¬åœ°ç¼“å­˜');
    </script>
</body>
</html>
