<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•æ•°æ®é‡ç½®å·¥å…·</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <style>
        .container {
            max-width: 600px;
            margin-top: 50px;
            text-align: center;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
            border: 4px solid #000;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .status-log {
            margin-top: 20px;
            text-align: left;
            background: #000;
            padding: 15px;
            border: 4px solid var(--stroke);
            font-family: monospace;
            font-size: 12px;
            min-height: 150px;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-line { color: var(--muted); margin-bottom: 4px; }
        .log-success { color: var(--green); }
        .log-error { color: #ef4444; }
        .log-warning { color: var(--yellow); }
        .whitelist-box {
            background: var(--bg);
            padding: 15px;
            border: 2px solid var(--stroke);
            margin: 15px 0;
            border-radius: 4px;
            text-align: left;
        }
        .whitelist-item {
            color: var(--yellow);
            font-family: monospace;
            font-size: 13px;
            padding: 4px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="pixel-card">
            <h1 style="margin-bottom: 20px; color: var(--txt);">ğŸš§ æµ‹è¯•æ•°æ®é‡ç½®å·¥å…·</h1>
            
            <!-- ç™½åå•æ˜¾ç¤º -->
            <div class="whitelist-box">
                <div style="color: var(--muted); font-size: 12px; margin-bottom: 8px;">
                    ğŸ“‹ æµ‹è¯•è´¦å·ç™½åå•ï¼ˆåªæœ‰è¿™äº›è´¦å·çš„æ•°æ®ä¼šè¢«æ¸…ç©ºï¼‰
                </div>
                <div id="whitelistDisplay" style="color: var(--yellow); font-family: monospace; font-size: 13px;">
                    <!-- ç™½åå•è´¦å·å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <p style="color: var(--muted); font-size: 14px; margin-bottom: 10px;">å‰ç«¯çŠ¶æ€æ¸…ç†</p>
                <button id="clearLocalBtn" class="pixel-btn full-width">
                    1. æ¸…é™¤æœ¬åœ°ç™»é™†ç¼“å­˜
                </button>
            </div>

            <div style="margin-bottom: 20px;">
                <p style="color: var(--muted); font-size: 14px; margin-bottom: 10px;">åç«¯æ•°æ®æ¸…ç†ï¼ˆä»…æ¸…ç©ºç™½åå•å†…æµ‹è¯•è´¦å·æ•°æ®ï¼‰</p>
                <button id="clearCheckinsBtn" class="pixel-btn btn-danger full-width">
                    2. æ¸…ç©ºæµ‹è¯•è´¦å·æ‰“å¡è®°å½•
                </button>
                <button id="clearCommentsBtn" class="pixel-btn btn-danger full-width" style="margin-top: 10px;">
                    3. æ¸…ç©ºæµ‹è¯•è´¦å·è¯„è®ºæ•°æ®
                </button>
                <button id="clearLikesBtn" class="pixel-btn btn-danger full-width" style="margin-top: 10px;">
                    4. æ¸…ç©ºæµ‹è¯•è´¦å·ç‚¹èµæ•°æ®
                </button>
                <button id="clearAllTestDataBtn" class="pixel-btn btn-danger full-width" style="margin-top: 15px; background: #dc2626;">
                    ğŸ”¥ ä¸€é”®æ¸…ç©ºæ‰€æœ‰æµ‹è¯•æ•°æ®
                </button>
            </div>

            <div style="border-top: 1px solid var(--stroke); padding-top: 20px; margin-top: 20px;">
                 <a href="/checkin/login" class="pixel-btn" style="background: var(--panel); color: var(--txt); width: 100%; justify-content: center;">
                    è¿”å›ç™»é™†é¡µ
                </a>
            </div>
        </div>

        <div id="logBox" class="status-log">
            <div class="log-line">å‡†å¤‡å°±ç»ª...</div>
        </div>
    </div>

    <script src="supabase.js"></script>
    <script>
        // ==================== æµ‹è¯•è´¦å·ç™½åå• ====================
        // åªæœ‰åœ¨è¿™ä¸ªç™½åå•å†…çš„è´¦å·æ•°æ®æ‰ä¼šè¢«æ¸…ç©º
        const TEST_ACCOUNTS_WHITELIST = [
            '15626179745',  // æµ‹è¯•å­¦å‘˜
            // å¯ä»¥ç»§ç»­æ·»åŠ å…¶ä»–æµ‹è¯•è´¦å·
        ];

        // æ˜¾ç¤ºç™½åå•
        function displayWhitelist() {
            const container = document.getElementById('whitelistDisplay');
            if (TEST_ACCOUNTS_WHITELIST.length === 0) {
                container.innerHTML = '<div style="color: var(--muted);">æš‚æ— æµ‹è¯•è´¦å·</div>';
            } else {
                container.innerHTML = TEST_ACCOUNTS_WHITELIST
                    .map(phone => `<div class="whitelist-item">ğŸ“± ${phone}</div>`)
                    .join('');
            }
        }

        // è·å–ç™½åå•å†…æµ‹è¯•è´¦å·çš„ user_id
        async function getTestUserIds() {
            try {
                log('æ­£åœ¨æŸ¥è¯¢æµ‹è¯•è´¦å·...');
                
                const { data: users, error } = await supabase
                    .from('users')
                    .select('id, phone, name')
                    .in('phone', TEST_ACCOUNTS_WHITELIST);

                if (error) throw error;

                if (!users || users.length === 0) {
                    log('âš ï¸ æœªæ‰¾åˆ°ä»»ä½•æµ‹è¯•è´¦å·', 'warning');
                    return [];
                }

                log(`âœ“ æ‰¾åˆ° ${users.length} ä¸ªæµ‹è¯•è´¦å·:`, 'success');
                users.forEach(u => {
                    log(`  - ${u.name} (${u.phone})`, 'success');
                });

                return users.map(u => u.id);
            } catch (e) {
                log('æŸ¥è¯¢æµ‹è¯•è´¦å·å¤±è´¥: ' + e.message, 'error');
                return [];
            }
        }

        // æ—¥å¿—å·¥å…·
        function log(msg, type = 'normal') {
            const box = document.getElementById('logBox');
            const div = document.createElement('div');
            div.className = 'log-line';
            if (type === 'success') div.classList.add('log-success');
            if (type === 'error') div.classList.add('log-error');
            if (type === 'warning') div.classList.add('log-warning');
            
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            div.textContent = `[${timestamp}] ${msg}`;
            
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // ==================== æ¸…ç†åŠŸèƒ½ ====================

        // 1. æ¸…é™¤æœ¬åœ°ç¼“å­˜
        document.getElementById('clearLocalBtn').addEventListener('click', () => {
            try {
                localStorage.clear();
                log('âœ“ æœ¬åœ° localStorage å·²æ¸…ç©º', 'success');
                log('âœ“ ç™»é™†çŠ¶æ€å·²é‡ç½®', 'success');
            } catch (e) {
                log('âœ— æ¸…é™¤æœ¬åœ°ç¼“å­˜å¤±è´¥: ' + e.message, 'error');
            }
        });

        // 2. æ¸…ç©ºæµ‹è¯•è´¦å·æ‰“å¡è®°å½•
        document.getElementById('clearCheckinsBtn').addEventListener('click', async () => {
            if (!confirm('ç¡®å®šè¦åˆ é™¤ç™½åå•å†…æµ‹è¯•è´¦å·çš„æ‰“å¡è®°å½•å—ï¼Ÿ')) return;

            try {
                const testUserIds = await getTestUserIds();
                if (testUserIds.length === 0) {
                    log('âš ï¸ æ²¡æœ‰å¯æ¸…ç†çš„æµ‹è¯•è´¦å·', 'warning');
                    return;
                }

                log('æ­£åœ¨åˆ é™¤æ‰“å¡è®°å½•...');
                
                const { data, error } = await supabase
                    .from('checkins')
                    .delete()
                    .in('user_id', testUserIds);

                if (error) throw error;

                log('âœ“ æµ‹è¯•è´¦å·æ‰“å¡è®°å½•å·²æ¸…ç©º', 'success');
            } catch (e) {
                console.error(e);
                log('âœ— åˆ é™¤æ‰“å¡è®°å½•å¤±è´¥: ' + e.message, 'error');
            }
        });

        // 3. æ¸…ç©ºæµ‹è¯•è´¦å·è¯„è®ºæ•°æ®
        document.getElementById('clearCommentsBtn').addEventListener('click', async () => {
            if (!confirm('ç¡®å®šè¦åˆ é™¤ç™½åå•å†…æµ‹è¯•è´¦å·çš„è¯„è®ºæ•°æ®å—ï¼Ÿ')) return;

            try {
                const testUserIds = await getTestUserIds();
                if (testUserIds.length === 0) {
                    log('âš ï¸ æ²¡æœ‰å¯æ¸…ç†çš„æµ‹è¯•è´¦å·', 'warning');
                    return;
                }

                log('æ­£åœ¨åˆ é™¤è¯„è®ºæ•°æ®...');
                
                const { data, error } = await supabase
                    .from('comments')
                    .delete()
                    .in('user_id', testUserIds);

                if (error) throw error;

                log('âœ“ æµ‹è¯•è´¦å·è¯„è®ºæ•°æ®å·²æ¸…ç©º', 'success');
            } catch (e) {
                console.error(e);
                log('âœ— åˆ é™¤è¯„è®ºæ•°æ®å¤±è´¥: ' + e.message, 'error');
            }
        });

        // 4. æ¸…ç©ºæµ‹è¯•è´¦å·ç‚¹èµæ•°æ®
        document.getElementById('clearLikesBtn').addEventListener('click', async () => {
            if (!confirm('ç¡®å®šè¦åˆ é™¤ç™½åå•å†…æµ‹è¯•è´¦å·çš„ç‚¹èµæ•°æ®å—ï¼Ÿ')) return;

            try {
                const testUserIds = await getTestUserIds();
                if (testUserIds.length === 0) {
                    log('âš ï¸ æ²¡æœ‰å¯æ¸…ç†çš„æµ‹è¯•è´¦å·', 'warning');
                    return;
                }

                log('æ­£åœ¨åˆ é™¤ç‚¹èµæ•°æ®...');
                
                const { data, error } = await supabase
                    .from('likes')
                    .delete()
                    .in('user_id', testUserIds);

                if (error) throw error;

                log('âœ“ æµ‹è¯•è´¦å·ç‚¹èµæ•°æ®å·²æ¸…ç©º', 'success');
            } catch (e) {
                console.error(e);
                log('âœ— åˆ é™¤ç‚¹èµæ•°æ®å¤±è´¥: ' + e.message, 'error');
            }
        });

        // 5. ä¸€é”®æ¸…ç©ºæ‰€æœ‰æµ‹è¯•æ•°æ®
        document.getElementById('clearAllTestDataBtn').addEventListener('click', async () => {
            if (!confirm('âš ï¸ ç¡®å®šè¦åˆ é™¤ç™½åå•å†…æµ‹è¯•è´¦å·çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿ\n\nåŒ…æ‹¬ï¼š\n- æ‰“å¡è®°å½•\n- è¯„è®ºæ•°æ®\n- ç‚¹èµæ•°æ®\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

            try {
                const testUserIds = await getTestUserIds();
                if (testUserIds.length === 0) {
                    log('âš ï¸ æ²¡æœ‰å¯æ¸…ç†çš„æµ‹è¯•è´¦å·', 'warning');
                    return;
                }

                log('========================================');
                log('ğŸ”¥ å¼€å§‹æ¸…ç©ºæ‰€æœ‰æµ‹è¯•æ•°æ®...', 'warning');
                log('========================================');

                // åˆ é™¤æ‰“å¡è®°å½•
                log('1/3 æ­£åœ¨åˆ é™¤æ‰“å¡è®°å½•...');
                const { error: checkinsError } = await supabase
                    .from('checkins')
                    .delete()
                    .in('user_id', testUserIds);
                
                if (checkinsError) throw checkinsError;
                log('  âœ“ æ‰“å¡è®°å½•å·²æ¸…ç©º', 'success');

                // åˆ é™¤è¯„è®º
                log('2/3 æ­£åœ¨åˆ é™¤è¯„è®ºæ•°æ®...');
                const { error: commentsError } = await supabase
                    .from('comments')
                    .delete()
                    .in('user_id', testUserIds);
                
                if (commentsError) throw commentsError;
                log('  âœ“ è¯„è®ºæ•°æ®å·²æ¸…ç©º', 'success');

                // åˆ é™¤ç‚¹èµ
                log('3/3 æ­£åœ¨åˆ é™¤ç‚¹èµæ•°æ®...');
                const { error: likesError } = await supabase
                    .from('likes')
                    .delete()
                    .in('user_id', testUserIds);
                
                if (likesError) throw likesError;
                log('  âœ“ ç‚¹èµæ•°æ®å·²æ¸…ç©º', 'success');

                log('========================================');
                log('âœ… æ‰€æœ‰æµ‹è¯•æ•°æ®æ¸…ç†å®Œæˆï¼', 'success');
                log('========================================');

            } catch (e) {
                console.error(e);
                log('âœ— æ¸…ç†è¿‡ç¨‹ä¸­å‡ºé”™: ' + e.message, 'error');
            }
        });

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºç™½åå•
        window.addEventListener('DOMContentLoaded', () => {
            displayWhitelist();
            log('âœ“ å·¥å…·åˆå§‹åŒ–å®Œæˆ', 'success');
            log(`âœ“ å½“å‰æœ‰ ${TEST_ACCOUNTS_WHITELIST.length} ä¸ªæµ‹è¯•è´¦å·åœ¨ç™½åå•ä¸­`, 'success');
        });
    </script>
</body>
</html>
